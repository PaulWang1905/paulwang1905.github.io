---
Title: Setup Wireguard
Summary: Setting up Wireguard for 
Authors: Puyu Wang
Date: 2024-07-26
Last_modified: 2025-10-20
Category: Blog
Tags: 
    - Wireguard
    - VPN
---

# Setting Up Wireguard


# How to Set Up WireGuard as a VPN Server and Connect All Your Devices

## Introduction

WireGuard is a modern, fast, and secure VPN protocol that's significantly simpler to configure than traditional VPN solutions like OpenVPN or IPSec. In this guide, you'll learn how to set up a WireGuard VPN server and connect all your devices to create a secure, unified network.

## What You'll Achieve

By the end of this tutorial, you'll have:
- A WireGuard VPN server running on a Linux machine
- Multiple devices (phones, tablets, laptops) connected to your private network
- Secure encrypted communication between all devices
- The ability to access your home network remotely

## Prerequisites

- A Linux server (Ubuntu/Debian recommended) with root access
- A static public IP address or dynamic DNS service
- Port forwarding capability on your router
- Basic command-line knowledge

## Table of Contents

1. [Understanding WireGuard Basics](#understanding-wireguard-basics)
2. [Installing WireGuard](#installing-wireguard)
3. [Generating Keys](#generating-keys)
4. [Configuring the Server](#configuring-the-server)
5. [Configuring Clients](#configuring-clients)
6. [Network and Firewall Setup](#network-and-firewall-setup)
7. [Testing Your VPN](#testing-your-vpn)
8. [Troubleshooting](#troubleshooting)

---

## Understanding WireGuard Basics

### How WireGuard Works

WireGuard uses public-key cryptography (similar to SSH) to establish secure tunnels. Each device has:
- **Private Key**: Kept secret on the device
- **Public Key**: Shared with peers
- **Preshared Key** (optional): Additional layer of security

### Network Topology

In our setup:
- **Server**: Acts as the central hub (e.g., `10.0.0.1/24`)
- **Peers**: All client devices (e.g., `10.0.0.2`, `10.0.0.3`, etc.)
- All traffic is encrypted and routed through the server

---

## Installing WireGuard

### On Ubuntu/Debian Server

```bash
# Update package list
sudo apt update

# Install WireGuard
sudo apt install wireguard

# Verify installation
wg --version
```

### On Other Systems

- **Arch Linux**: `sudo pacman -S wireguard-tools`
- **Fedora/CentOS**: `sudo dnf install wireguard-tools`
- **macOS**: `brew install wireguard-tools`

---

## Generating Keys

### Understanding Key Security

Before generating keys, set the proper umask to ensure your private keys are only readable by you:

```bash
umask 077
```

### Server Keys

Generate keys for your WireGuard server:

```bash
# Navigate to WireGuard directory
cd /etc/wireguard/

# Generate server private and public keys
wg genkey | tee server_privatekey | wg pubkey > server_publickey

# View the keys (note them down securely)
cat server_privatekey
cat server_publickey
```

### Client Keys (Automated Script)

For multiple clients, use this script to generate all keys at once:

```bash
#!/bin/bash
umask 077

# Define your peers (customize this list)
peers=("peerPaulineDell" "peeriPhone" "peeriPad" "peerThinkpad" "peerXiaoxin")

# Generate keys for each peer
for peer in "${peers[@]}"; do
  wg genkey | tee "${peer}_privatekey" | wg pubkey > "${peer}_publickey"
  wg genpsk > "${peer}_presharedkey"
  
  echo "Keys generated for ${peer}:"
  echo "  - Private Key: ${peer}_privatekey"
  echo "  - Public Key: ${peer}_publickey"
  echo "  - Preshared Key: ${peer}_presharedkey"
  echo ""
done

echo "All keys generated successfully!"
```

Save this script as `generate_peer_keys.sh`, make it executable, and run it:

```bash
chmod +x generate_peer_keys.sh
./generate_peer_keys.sh
```

**Important**: Store these keys securely! Anyone with a private key can access your VPN.

---

## Configuring the Server

### Create Server Configuration

Create `/etc/wireguard/wg0.conf`:

```ini
[Interface]
# Server private key
PrivateKey = <SERVER_PRIVATE_KEY>

# Server IP address in the VPN network
Address = 10.0.0.1/24

# UDP port for WireGuard (default: 51820)
ListenPort = 51820

# Enable IP forwarding
PostUp = sysctl -w net.ipv4.ip_forward=1
PostUp = iptables -A FORWARD -i wg0 -j ACCEPT
PostUp = iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE

# Disable IP forwarding on shutdown
PostDown = iptables -D FORWARD -i wg0 -j ACCEPT
PostDown = iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE

### Peer 1: Pauline's Dell Laptop ###
[Peer]
# Client's public key
PublicKey = <PEER_PAULINE_DELL_PUBLIC_KEY>

# Optional: Preshared key for additional security
PresharedKey = <PEER_PAULINE_DELL_PRESHARED_KEY>

# IP address assigned to this peer
AllowedIPs = 10.0.0.2/32

### Peer 2: iPhone ###
[Peer]
PublicKey = <PEER_IPHONE_PUBLIC_KEY>
PresharedKey = <PEER_IPHONE_PRESHARED_KEY>
AllowedIPs = 10.0.0.3/32

### Peer 3: iPad ###
[Peer]
PublicKey = <PEER_IPAD_PUBLIC_KEY>
PresharedKey = <PEER_IPAD_PRESHARED_KEY>
AllowedIPs = 10.0.0.4/32

### Peer 4: Thinkpad ###
[Peer]
PublicKey = <PEER_THINKPAD_PUBLIC_KEY>
PresharedKey = <PEER_THINKPAD_PRESHARED_KEY>
AllowedIPs = 10.0.0.5/32

### Peer 5: Xiaoxin ###
[Peer]
PublicKey = <PEER_XIAOXIN_PUBLIC_KEY>
PresharedKey = <PEER_XIAOXIN_PRESHARED_KEY>
AllowedIPs = 10.0.0.6/32
```

**Note**: Replace `eth0` with your actual network interface name. Find it using `ip link show`.

### Set Proper Permissions

```bash
sudo chmod 600 /etc/wireguard/wg0.conf
```

### Enable IP Forwarding Permanently

Edit `/etc/sysctl.conf`:

```bash
sudo nano /etc/sysctl.conf
```

Add or uncomment:

```
net.ipv4.ip_forward=1
```

Apply changes:

```bash
sudo sysctl -p
```

### Start WireGuard Server

```bash
# Start the VPN
sudo wg-quick up wg0

# Enable automatic startup on boot
sudo systemctl enable wg-quick@wg0

# Check status
sudo wg show
```

---

## Configuring Clients

### Linux/macOS Client Configuration

Create `/etc/wireguard/wg0.conf` on each client:

```ini
[Interface]
# Client's private key
PrivateKey = <PEER_PRIVATE_KEY>

# Client's VPN IP address
Address = 10.0.0.2/32

# Optional: DNS servers to use when connected
DNS = 1.1.1.1, 8.8.8.8

[Peer]
# Server's public key
PublicKey = <SERVER_PUBLIC_KEY>

# Preshared key
PresharedKey = <PEER_PRESHARED_KEY>

# Server's public IP and port
Endpoint = <SERVER_PUBLIC_IP>:51820

# Route all traffic through VPN (full tunnel)
AllowedIPs = 0.0.0.0/0, ::/0

# Keep connection alive (important for mobile)
PersistentKeepalive = 25
```

**Configuration Options Explained**:

- **AllowedIPs = 0.0.0.0/0**: Routes all traffic through VPN (full tunnel)
- **AllowedIPs = 10.0.0.0/24**: Routes only VPN subnet traffic (split tunnel)
- **PersistentKeepalive = 25**: Sends keepalive packets every 25 seconds to maintain NAT mappings

Start the client:

```bash
sudo wg-quick up wg0
```

### iOS Configuration

1. Install **WireGuard** from the App Store
2. Tap **Add a tunnel** â†’ **Create from scratch**
3. Enter configuration:
   - **Name**: Home VPN
   - **Private Key**: Generate or paste peer private key
   - **Addresses**: `10.0.0.3/32`
   - **DNS Servers**: `1.1.1.1, 8.8.8.8`
   - **Public Key**: Server's public key
   - **Preshared Key**: Peer's preshared key
   - **Endpoint**: `<SERVER_PUBLIC_IP>:51820`
   - **Allowed IPs**: `0.0.0.0/0, ::/0`
   - **Persistent Keepalive**: `25`
4. Save and toggle on

### Android Configuration

1. Install **WireGuard** from Google Play
2. Tap **+** â†’ **Create from scratch**
3. Follow similar steps as iOS configuration
4. Save and activate

### Windows Configuration

1. Download and install WireGuard from [wireguard.com](https://www.wireguard.com/install/)
2. Click **Add Tunnel** â†’ **Add empty tunnel**
3. Paste the client configuration
4. Click **Save** and **Activate**

---

## Network and Firewall Setup

### Router Configuration

1. **Port Forwarding**:
   - Forward UDP port `51820` to your server's local IP
   - Example: External `51820` â†’ Internal `192.168.1.100:51820`

2. **Dynamic DNS** (if you don't have a static IP):
   - Use services like No-IP, DuckDNS, or Cloudflare
   - Update your client configs with the dynamic DNS hostname

### Firewall Configuration (UFW)

```bash
# Allow WireGuard port
sudo ufw allow 51820/udp

# Allow SSH (important!)
sudo ufw allow 22/tcp

# Enable firewall
sudo ufw enable

# Check status
sudo ufw status
```

### Firewall Configuration (iptables)

If you're using iptables directly:

```bash
# Allow WireGuard
sudo iptables -A INPUT -p udp --dport 51820 -j ACCEPT

# Allow forwarding for VPN subnet
sudo iptables -A FORWARD -i wg0 -j ACCEPT
sudo iptables -A FORWARD -o wg0 -j ACCEPT

# Enable NAT
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE

# Save rules
sudo netfilter-persistent save
```

---

## Testing Your VPN

### Verify Server Status

```bash
# Check if WireGuard is running
sudo wg show

# Should show connected peers
sudo wg show wg0
```

Expected output:
```
interface: wg0
  public key: <server_public_key>
  private key: (hidden)
  listening port: 51820

peer: <peer1_public_key>
  preshared key: (hidden)
  endpoint: <peer_ip>:<peer_port>
  allowed ips: 10.0.0.2/32
  latest handshake: 30 seconds ago
  transfer: 15.2 MiB received, 8.4 MiB sent
```

### Test Connectivity from Client

```bash
# Ping the server
ping 10.0.0.1

# Ping another peer
ping 10.0.0.3

# Check your public IP (should show server's IP)
curl ifconfig.me
```

### Test Peer-to-Peer Communication

From one client, ping another:

```bash
# From iPhone (10.0.0.3) to Thinkpad (10.0.0.5)
ping 10.0.0.5
```

---

## Troubleshooting

### Common Issues

**1. Can't Connect to Server**

Check firewall and port forwarding:
```bash
# On server, verify listening port
sudo ss -tulpn | grep 51820

# Test port from outside
nmap -sU -p 51820 <SERVER_PUBLIC_IP>
```

**2. Connected but No Internet**

Verify IP forwarding:
```bash
# Check if enabled
sysctl net.ipv4.ip_forward

# Enable if needed
sudo sysctl -w net.ipv4.ip_forward=1
```

Check NAT/masquerading:
```bash
sudo iptables -t nat -L POSTROUTING -v
```

**3. Peers Can't See Each Other**

Ensure `AllowedIPs` on server includes each peer's IP:
```ini
[Peer]
AllowedIPs = 10.0.0.2/32  # Must match client's Address
```

**4. Frequent Disconnections**

Increase keepalive interval in client config:
```ini
PersistentKeepalive = 25
```

**5. DNS Not Working**

Add DNS servers to client config:
```ini
[Interface]
DNS = 1.1.1.1, 8.8.8.8
```

### Debugging Commands

```bash
# View detailed WireGuard status
sudo wg show all

# Monitor WireGuard logs
sudo journalctl -u wg-quick@wg0 -f

# Check routing table
ip route show table all

# Test DNS resolution
nslookup google.com
```

---

## Security Best Practices

1. **Key Management**:
   - Never share private keys
   - Regenerate keys if compromised
   - Use preshared keys for additional security

2. **Regular Updates**:
   ```bash
   sudo apt update && sudo apt upgrade -y
   ```

3. **Limit Server Access**:
   - Use SSH key authentication only
   - Disable password authentication
   - Use fail2ban to prevent brute force attacks

4. **Monitor Connections**:
   ```bash
   # Script to monitor active peers
   watch -n 5 'sudo wg show wg0'
   ```

5. **Backup Configuration**:
   ```bash
   sudo cp -r /etc/wireguard/ ~/wireguard-backup/
   ```

---

## Advanced Configuration

### Split Tunneling

To route only specific traffic through VPN (e.g., home network only):

Client configuration:
```ini
[Peer]
# Only route home network traffic through VPN
AllowedIPs = 10.0.0.0/24, 192.168.1.0/24
```

### DNS-Based Ad Blocking

Use Pi-hole as your VPN DNS server:

Server configuration:
```ini
[Interface]
PostUp = iptables -A FORWARD -i wg0 -j ACCEPT
PostUp = iptables -A FORWARD -o wg0 -j ACCEPT
```

Client configuration:
```ini
[Interface]
DNS = 10.0.0.1  # Server running Pi-hole
```

### Quality of Service (QoS)

Prioritize certain traffic types:
```bash
sudo tc qdisc add dev wg0 root fq_codel
```

---

## Useful Scripts

### Automatic Key Generation and Config Creator

```bash
#!/bin/bash
# save as: create_peer.sh

PEER_NAME=$1
SERVER_PUBLIC_IP=$2
SERVER_PUBLIC_KEY=$3

if [ -z "$PEER_NAME" ] || [ -z "$SERVER_PUBLIC_IP" ] || [ -z "$SERVER_PUBLIC_KEY" ]; then
    echo "Usage: ./create_peer.sh <peer_name> <server_public_ip> <server_public_key>"
    exit 1
fi

umask 077

# Generate keys
PRIVATE_KEY=$(wg genkey)
PUBLIC_KEY=$(echo "$PRIVATE_KEY" | wg pubkey)
PRESHARED_KEY=$(wg genpsk)

# Create client config
cat > "${PEER_NAME}.conf" <<EOF
[Interface]
PrivateKey = ${PRIVATE_KEY}
Address = 10.0.0.X/32
DNS = 1.1.1.1, 8.8.8.8

[Peer]
PublicKey = ${SERVER_PUBLIC_KEY}
PresharedKey = ${PRESHARED_KEY}
Endpoint = ${SERVER_PUBLIC_IP}:51820
AllowedIPs = 0.0.0.0/0, ::/0
PersistentKeepalive = 25
EOF

echo "Client config created: ${PEER_NAME}.conf"
echo ""
echo "Add this to your server config:"
echo "[Peer]"
echo "PublicKey = ${PUBLIC_KEY}"
echo "PresharedKey = ${PRESHARED_KEY}"
echo "AllowedIPs = 10.0.0.X/32"
```

---

## Conclusion

You now have a fully functional WireGuard VPN server connecting all your devices! This setup provides:

- **Security**: All traffic is encrypted end-to-end
- **Privacy**: Your internet traffic appears to come from your server
- **Flexibility**: Access your home network from anywhere
- **Performance**: WireGuard is extremely fast and efficient

### Next Steps

- Set up automatic backups of your configuration
- Implement monitoring with Prometheus and Grafana
- Configure split tunneling for optimal performance
- Add more advanced firewall rules
- Explore WireGuard mesh networks for peer-to-peer connectivity

### Additional Resources

- [Official WireGuard Documentation](https://www.wireguard.com/)
- [WireGuard Quick Start](https://www.wireguard.com/quickstart/)
- [Awesome WireGuard](https://github.com/cedrickchee/awesome-wireguard)

---

**Questions or Issues?** Feel free to leave a comment below or check the troubleshooting section above.

Happy VPN-ing! ðŸ”’ðŸŒ


